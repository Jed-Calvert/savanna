---
title: "Untitled"
author: "abbey yatsko"
date: "2024-10-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyr)
library(dplyr)
```

load data
```{r}
tony_outputs_original <- read.csv("data/tony_output_original.csv")
tony_outputs_far <- read.csv("data/tony_output_far.csv")

tony_outputs <- rbind(tony_outputs_original, tony_outputs_far)
```


working with Tony's outputs: full list of fulls 
```{r}
tony_outputs$name <- sub(".*_", "", tony_outputs$name)
outputs <- tony_outputs
unique(outputs$name) # 32 different folds 
```

weight by area, translate heights to shade volume, calculate residuals
```{r}
# weight by area 
outputs$weighted_test_area <- outputs$test_area / 900

# heights to shade volume, weighted by test area
outputs <- outputs %>%
  mutate(ground_truth_mean_sv = (ground_truth_mean*weighted_test_area) * 0.25,
         prediction_mean_sv = (prediction_mean*weighted_test_area) * 0.25)

outputs <- outputs %>%
  mutate(residuals = ground_truth_mean_sv - prediction_mean_sv)

outputs <- na.omit(outputs)
```

Calculate error metrics 
```{r}
# Group by height classes and calculate the metrics for the whole dataset
metrics_all <- outputs %>%
  group_by(name) %>% # remove height_class if you want to calculate for the whole dataset
  summarise(MAE = mean(abs(ground_truth_mean_sv - prediction_mean_sv), na.rm = TRUE),
            RMSE = sqrt(mean((ground_truth_mean_sv - prediction_mean_sv)^2, na.rm = TRUE)),
            MBE = mean(prediction_mean_sv - ground_truth_mean_sv, na.rm = TRUE),
            R2 = summary(lm(prediction_mean_sv ~ ground_truth_mean_sv))$r.squared,
            mean_observed = mean(ground_truth_mean_sv), 
            MAE_p = MAE / mean_observed, 
            RMSE_p = RMSE / mean_observed, 
            MBE_p = MBE / mean_observed, 
            MAE_p_inv = 1- MAE_p, 
            RMSE_p_inv = 1 - RMSE_p, 
            MBE_p_inv = 1 - MBE_p) # mean of observed shade volume for a given fold

metrics_all <- as.data.frame(metrics_all)
```

Visualization
```{r}
# convert to long format by height class
metrics_long_all <- metrics_all %>%
  pivot_longer(cols = c(MAE, RMSE, MBE, R2, mean_observed), 
               names_to = "Metric", 
               values_to = "Value")

ggplot(metrics_long_all, aes(x = Metric, y = Value, color = Metric)) +
  geom_boxplot() +  # Change to boxplo
  labs(title = "Mean Error Metrics",
       x = "Metric", 
       y = "Error") +
  facet_wrap(~Metric, scales = "free", ncol = 3) +  # Facet by Metric
  theme_minimal()  # Minimal theme for a clean look
```

Weighted error by fold
```{r}
# weighted error calculation 
alpha <- 1/3  # Weight for MAE
beta <- 1/3   # Weight for RMSE
gamma <- 1/3  # Weight for RÂ²

metrics_all <- metrics_all %>%
  group_by(name) %>%
  mutate(
    Raw_Weight = alpha * MAE_p_inv + beta * RMSE_p_inv + gamma * R2
  )

# plot to make sure it makes sense - there should be a strong correlation between higher R2 and weight
ggplot(metrics_all, aes(x = R2, y = Raw_Weight)) +
  geom_point() + 
  theme_classic()

# there should be a strong correlation between higher RMSE and weight
ggplot(metrics_all, aes(x = RMSE_p_inv, y = Raw_Weight)) +
  geom_point() + 
  theme_classic()

# there should be a strong correlation between higher MAE and weight
ggplot(metrics_all, aes(x = MAE_p_inv, y = Raw_Weight)) +
  geom_point() + 
  theme_classic()

# export as csv
# write.csv(metrics_all, "data/data_out/metrics_all.csv", row.names = FALSE)
```

EXTRA Error by height classes
```{r}
# Create height bins (3m bins, from 0 to 30m)
outputs <- outputs %>%
  mutate(height_class = cut(ground_truth_mean, breaks = seq(0, 30, by = 3), include.lowest = TRUE))

# Group by height classes and calculate the metrics for each class
metrics_by_class <- outputs %>%
  group_by(name, height_class) %>% # remove height_class if you want to calculate for the whole dataset
  summarise(MAE = mean(abs(ground_truth_mean_sv - prediction_mean_sv), na.rm = TRUE),
            RMSE = sqrt(mean((ground_truth_mean_sv - prediction_mean_sv)^2, na.rm = TRUE)),
            MBE = mean(prediction_mean_sv - ground_truth_mean_sv, na.rm = TRUE),
            R2 = summary(lm(prediction_mean_sv ~ ground_truth_mean_sv))$r.squared,
            Pearson_R = cor(ground_truth_mean_sv, prediction_mean_sv, use = "complete.obs"),
            MAPE = mean(abs((ground_truth_mean_sv - prediction_mean_sv) / ground_truth_mean_sv) * 100, na.rm = TRUE)) # Add MAPE

# convert to long format by height class
metrics_long <- metrics_by_class %>%
  pivot_longer(cols = c(MAE, RMSE, MBE, R2, Pearson_R, MAPE), 
               names_to = "Metric", 
               values_to = "Value")

# visualization: error by height class
ggplot(metrics_long, aes(x = height_class, y = Value, fill = height_class)) +
  geom_boxplot() +  # Change to boxplot
  scale_fill_viridis_d() +  # Use viridis color palette
  labs(title = "Error Metrics by Height Class",
       x = "Height Class (m)", 
       y = "Error (m)", 
       fill = "Height class") +
  facet_wrap(~Metric, scales = "free", ncol = 3) +  # Facet by Metric
  theme_minimal()  # Minimal theme for a clean look
```

```







