---
title: "Untitled"
output: html_document
date: "2024-10-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyr)
library(dplyr)
```

load data
```{r}
ALS_10m_0 <- read.csv("split0/ALS_10m_0.csv")
ALS_20m_0 <- read.csv("split0/ALS_20m_0.csv")
CNN_10m_0 <- read.csv("split0/CNN_10m_0.csv")
CNN_20m_0 <- read.csv("split0/CNN_20m_0.csv")

ALS_10m_1 <- read.csv("split1/ALS_10m_1.csv")
ALS_20m_1 <- read.csv("split1/ALS_20m_1.csv")
CNN_10m_1 <- read.csv("split1/CNN_10m_1.csv")
CNN_20m_1 <- read.csv("split1/CNN_20m_1.csv")
```

join data and calculate residuals
```{r}
# split 0: join ALS_10m_0 and ALS_20m_0 by 'id' 
split0_10m <- left_join(ALS_10m_0, CNN_10m_0)
names(split0_10m)[names(split0_10m) == "ALS_10m_0mean"] <- "ALS"
names(split0_10m)[names(split0_10m) == "CNN_10m_0mean"] <- "CNN"
split0_10m$grid <- "10"
split0_10m$split <- "0"

split0_20m <- left_join(ALS_20m_0, CNN_20m_0)
names(split0_20m)[names(split0_20m) == "ALS_20m_0mean"] <- "ALS"
names(split0_20m)[names(split0_20m) == "CNN_20m_0mean"] <- "CNN"
split0_20m$grid <- "20"
split0_20m$split <- "0"

# get rid of fid, left, top, right, bottom
split0_10m <- split0_10m[, -c(1, 3, 4, 5, 6)]
split0_20m <- split0_20m[, -c(2, 3, 4, 5)]

# split 1: join ALS_10m_0 and ALS_20m_0 by 'id' 
split1_10m <- left_join(ALS_10m_1, CNN_10m_1)
names(split1_10m)[names(split1_10m) == "ALS_10m_1mean"] <- "ALS"
names(split1_10m)[names(split1_10m) == "CNN_10m_1mean"] <- "CNN"
split1_10m$grid <- "10"
split1_10m$split <- "1"

split1_20m <- left_join(ALS_20m_1, CNN_20m_1)
names(split1_20m)[names(split1_20m) == "ALS_20m_1mean"] <- "ALS"
names(split1_20m)[names(split1_20m) == "CNN_20m_1mean"] <- "CNN"
split1_20m$grid <- "20"
split1_20m$split <- "1"

# get rid of fid, left, top, right, bottom
split1_10m <- split1_10m[, -c(1, 3, 4, 5, 6)]
split1_20m <- split1_20m[, -c(1, 3, 4, 5, 6)]

# rbind split0_10m and split0_20m
test1 <- rbind(split0_10m, split0_20m, split1_10m, split1_20m)
```


```{r}
# (a) Scatterplot of ALS vs CNN
ggplot(test1, aes(x = ALS, y = CNN)) +
  geom_point(alpha = 0.05) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +  # Add a reference line
  labs(title = "",
       x = "Observed ALS",
       y = "Predicted CNN") +
  facet_wrap(split~grid)+
  xlim(0,10)+
  ylim(0,10)+
  theme_minimal()

# (b) Calculate residuals
test1 <- test1 %>%
  mutate(residuals = ALS - CNN)
```

```{r}
test1 <- na.omit(test1)

# Create height bins (3m bins, from 0 to 30m)
test1 <- test1 %>%
  mutate(height_class = cut(ALS, breaks = seq(0, 30, by = 3), include.lowest = TRUE))

# Function to calculate the metrics
calculate_metrics <- function(df) {
  n <- nrow(df)
  mae <- mean(abs(df$ALS - df$CNN), na.rm = TRUE)
  rmse <- sqrt(mean((df$ALS - df$CNN)^2, na.rm = TRUE))
  mbe <- mean(df$CNN - df$ALS, na.rm = TRUE)
  r2 <- summary(lm(CNN ~ ALS, data = df))$r.squared
  r <- cor(df$ALS, df$CNN, use = "complete.obs")
  
  return(c(MAE = mae, RMSE = rmse, MBE = mbe, R2 = r2, Pearson_R = r))
}

# Group by height classes and calculate the metrics for each class
metrics_by_class <- test1 %>%
  group_by(grid, split, height_class) %>% # remove height_class if you want to calculate for the whole dataset
  summarise(MAE = mean(abs(ALS - CNN), na.rm = TRUE),
            RMSE = sqrt(mean((ALS - CNN)^2, na.rm = TRUE)),
            MBE = mean(CNN - ALS, na.rm = TRUE),
            R2 = summary(lm(CNN ~ ALS))$r.squared,
            Pearson_R = cor(ALS, CNN, use = "complete.obs"))

# View the resulting table
print(metrics_by_class)
```

```{r}
# Reshape the metrics_by_class to long format
metrics_long <- metrics_by_class %>%
  pivot_longer(cols = c(MAE, RMSE, MBE), 
               names_to = "Metric", 
               values_to = "Value")

# Plot the metrics using ggplot
ggplot(metrics_long, aes(x = height_class, y = Value, fill = Metric)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_viridis_d() +  # Use viridis color palette
  labs(title = "Error Metrics by Height Class",
       x = "Height Class (m)", 
       y = "Error (m)", 
       fill = "Metric") +
  facet_wrap(split~grid)+
  theme_minimal()

# plot of counts by each size cleass interval 
ggplot(test1, aes(x = height_class)) +
  geom_bar(fill = "blue") +
  labs(title = "Counts by Height Class",
       x = "Height Class (m)",
       y = "Count") +
  facet_wrap(~grid)+
  theme_minimal()
```

```{r}
```

```{r}
save.image("Metrics.RData")
```

